function QiniuJsSDK(){this.detectIEVersion=function(){var v=4,div=document.createElement('div'),all=div.getElementsByTagName('i');while(div.innerHTML='<!--[if gt IE '+v+']><i></i><![endif]-->',all[0]){v++}return v>4?v:false};this.isImage=function(a){var b,suffix="";var c=["png","jpg","jpeg","gif","bmp"];var d=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!a||!d.test(a)){return false}b=d.exec(a);suffix=b[1].toLowerCase();for(var i=0,l=c.length;i<l;i++){if(suffix===c[i]){return true}}return false};this.getFileExtension=function(a){var b=a.split(".");var c;if(b.length===1||(b[0]===""&&b.length===2)){c=""}else{c=b.pop().toLowerCase()}return c};this.utf8_encode=function(a){if(a===null||typeof a==='undefined'){return''}var b=(a+'');var c='',start,end,stringl=0;start=end=0;stringl=b.length;for(var n=0;n<stringl;n++){var d=b.charCodeAt(n);var e=null;if(d<128){end++}else if(d>127&&d<2048){e=String.fromCharCode((d>>6)|192,(d&63)|128)}else if(d&0xF800^0xD800>0){e=String.fromCharCode((d>>12)|224,((d>>6)&63)|128,(d&63)|128)}else{if(d&0xFC00^0xD800>0){throw new RangeError('Unmatched trail surrogate at '+n);}var f=b.charCodeAt(++n);if(f&0xFC00^0xDC00>0){throw new RangeError('Unmatched lead surrogate at '+(n-1));}d=((d&0x3FF)<<10)+(f&0x3FF)+0x10000;e=String.fromCharCode((d>>18)|240,((d>>12)&63)|128,((d>>6)&63)|128,(d&63)|128)}if(e!==null){if(end>start){c+=b.slice(start,end)}c+=e;start=end=n+1}}if(end>start){c+=b.slice(start,stringl)}return c};this.base64_encode=function(a){var b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';var c,o2,o3,h1,h2,h3,h4,bits,i=0,ac=0,enc='',tmp_arr=[];if(!a){return a}a=this.utf8_encode(a+'');do{c=a.charCodeAt(i++);o2=a.charCodeAt(i++);o3=a.charCodeAt(i++);bits=c<<16|o2<<8|o3;h1=bits>>18&0x3f;h2=bits>>12&0x3f;h3=bits>>6&0x3f;h4=bits&0x3f;tmp_arr[ac++]=b.charAt(h1)+b.charAt(h2)+b.charAt(h3)+b.charAt(h4)}while(i<a.length);enc=tmp_arr.join('');switch(a.length%3){case 1:enc=enc.slice(0,-2)+'==';break;case 2:enc=enc.slice(0,-1)+'=';break}return enc};this.URLSafeBase64Encode=function(v){v=this.base64_encode(v);return v.replace(/\//g,'_').replace(/\+/g,'-')};this.createAjax=function(a){var b={};if(window.XMLHttpRequest){b=new XMLHttpRequest()}else{b=new ActiveXObject("Microsoft.XMLHTTP")}return b};this.parseJSON=function(a){if(window.JSON&&window.JSON.parse){return window.JSON.parse(a)}if(a===null){return a}if(typeof a==="string"){a=null==a?"":(a+"").replace(/(^\s*)|(\s*$)/g,"");if(a){if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){return(function(){return a})()}}}};var B=this;this.uploader=function(s){if(!s.domain){throw'uptoken_url or domain is required!';}if(!s.browse_button){throw'browse_button is required!';}var t={};var u=s.init&&s.init.Error;var v=s.init&&s.init.FileUploaded;s.init.Error=function(){};s.init.FileUploaded=function(){};B.uptoken_url=s.uptoken_url;B.token='';B.key_handler=typeof s.init.Key==='function'?s.init.Key:'';this.domain=s.domain;var w='';var x=function(){var a=B.detectIEVersion();var b,MAX_CHUNK_SIZE,chunk_size;var c=(mOxie.Env.browser==="Safari"&&mOxie.Env.version<=5&&mOxie.Env.os==="Windows"&&mOxie.Env.osVersion==="7")||(mOxie.Env.browser==="Safari"&&mOxie.Env.os==="iOS"&&mOxie.Env.osVersion==="7");if(a&&a<=9&&s.chunk_size&&s.runtimes.indexOf('flash')>=0){s.chunk_size=0}else if(c){s.chunk_size=0}else{b=20;MAX_CHUNK_SIZE=4<<b;chunk_size=plupload.parseSize(s.chunk_size);if(chunk_size>MAX_CHUNK_SIZE){s.chunk_size=MAX_CHUNK_SIZE}}};x();var y=function(){if(!s.uptoken){var b=B.createAjax();b.open('GET',B.uptoken_url,true);b.setRequestHeader("If-Modified-Since","0");b.onreadystatechange=function(){if(b.readyState===4&&b.status===200){var a=B.parseJSON(b.responseText);if(typeof a=="string"){a=eval('('+a+')')}B.token=a.uptoken}};b.send()}else{B.token=s.uptoken}};var z=function(a,b,c){var d='',unique_names=false;if(!s.save_key){unique_names=a.getOption&&a.getOption('unique_names');unique_names=unique_names||(a.settings&&a.settings.unique_names);if(unique_names){var e=B.getFileExtension(b.name);d=e?b.id+'.'+e:b.id}else if(typeof c==='function'){d=c(a,b)}else{d=b.name}}return d};plupload.extend(t,s,{url:'http://up.qiniu.com',multipart_params:{token:''}});var A=new plupload.Uploader(t);A.bind('Init',function(a,b){y()});A.init();A.bind('FilesAdded',function(b,c){var d=b.getOption&&b.getOption('auto_start');d=d||(b.settings&&b.settings.auto_start);if(d){plupload.each(c,function(i,a){b.start()})}b.refresh()});A.bind('BeforeUpload',function(g,h){w='';var i=function(a,b,c){var d;if(s.save_key){d={'token':B.token}}else{d={'key':z(a,b,c),'token':B.token}}var e=s.x_vars;if(e!==undefined&&typeof e==='object'){for(var f in e){if(e.hasOwnProperty(f)){if(typeof e[f]==='function'){d['x:'+f]=e[f](a,b)}else if(typeof e[f]!=='object'){d['x:'+f]=e[f]}}}}a.setOption({'url':'http://up.qiniu.com/','multipart':true,'chunk_size':undefined,'multipart_params':d})};var j=g.getOption&&g.getOption('chunk_size');j=j||(g.settings&&g.settings.chunk_size);if(A.runtime==='html5'&&j){if(h.size<j){i(g,h,B.key_handler)}else{var k=localStorage.getItem(h.name);var l=j;if(k){k=JSON.parse(k);var m=(new Date()).getTime();var n=k.time||0;var o=24*60*60*1000;if(m-n<o){if(k.percent!==100){if(h.size===localStorage.total){h.percent=k.percent;h.loaded=k.offset;w=k.ctx;if(k.offset+l>h.size){l=h.size-k.offset}}else{localStorage.removeItem(h.name)}}else{localStorage.removeItem(h.name)}}else{localStorage.removeItem(h.name)}}g.setOption({'url':'http://up.qiniu.com/mkblk/'+l,'multipart':false,'chunk_size':j,'required_features':"chunks",'headers':{'Authorization':'UpToken '+B.token},'multipart_params':{}})}}else{i(g,h,B.key_handler)}});A.bind('ChunkUploaded',function(a,b,c){var d=B.parseJSON(c.response);w=w?w+','+d.ctx:d.ctx;var e=c.total-c.offset;var f=a.getOption&&a.getOption('chunk_size');f=f||(a.settings&&a.settings.chunk_size);if(e<f){a.setOption({'url':'http://up.qiniu.com/mkblk/'+e})}localStorage.setItem(b.name,JSON.stringify({ctx:w,percent:b.percent,total:c.total,offset:c.offset,time:(new Date()).getTime()}))});A.bind('Error',(function(i){return function(a,b){var c='';var d=b.file;if(d){switch(b.code){case plupload.FAILED:c='上传失败。请稍后再试。';break;case plupload.FILE_SIZE_ERROR:var f=a.getOption&&a.getOption('max_file_size');f=f||(a.settings&&a.settings.max_file_size);c='浏览器最大可上传'+f+'。更大文件请使用命令行工具。';break;case plupload.FILE_EXTENSION_ERROR:c='文件验证失败。请稍后重试。';break;case plupload.HTTP_ERROR:var g=B.parseJSON(b.response);var h=g.error;switch(b.status){case 400:c="请求报文格式错误。";break;case 401:c="客户端认证授权失败。请重试或提交反馈。";break;case 405:c="客户端请求错误。请重试或提交反馈。";break;case 579:c="资源上传成功，但回调失败。";break;case 599:c="网络连接异常。请重试或提交反馈。";break;case 614:c="文件已存在。";try{g=B.parseJSON(g.error);h=g.error||'file exists'}catch(e){h=g.error||'file exists'}break;case 631:c="指定空间不存在。";break;case 701:c="上传数据块校验出错。请重试或提交反馈。";break;default:c="未知错误。";break}c=c+'('+b.status+'：'+h+')';break;case plupload.SECURITY_ERROR:c='安全配置错误。请联系网站管理员。';break;case plupload.GENERIC_ERROR:c='上传失败。请稍后再试。';break;case plupload.IO_ERROR:c='上传失败。请稍后再试。';break;case plupload.INIT_ERROR:c='网站配置错误。请联系网站管理员。';A.destroy();break;default:c=b.message+b.details;break}if(i){i(a,b,c)}}a.refresh()}})(u));A.bind('FileUploaded',(function(r){return function(h,i,j){var k=function(c,d,f){if(s.downtoken_url){var g=B.createAjax();g.open('POST',s.downtoken_url,true);g.setRequestHeader('Content-type','application/x-www-form-urlencoded');g.onreadystatechange=function(){if(g.readyState===4){if(g.status===200){var a;try{a=B.parseJSON(g.responseText)}catch(e){throw('invalid json format');}var b={};plupload.extend(b,B.parseJSON(f),a);if(r){r(c,d,JSON.stringify(b))}}else{A.trigger('Error',{status:g.status,response:g.responseText,file:d,code:plupload.HTTP_ERROR})}}};g.send('key='+B.parseJSON(f).key+'&domain='+s.domain)}else if(r){r(c,d,f)}};var l=B.parseJSON(j.response);w=w?w:l.ctx;if(w){var m='';if(!s.save_key){m=z(h,i,B.key_handler);m=m?'/key/'+B.URLSafeBase64Encode(m):''}var n=s.x_vars,x_val='',x_vars_url='';if(n!==undefined&&typeof n==='object'){for(var o in n){if(n.hasOwnProperty(o)){if(typeof n[o]==='function'){x_val=B.URLSafeBase64Encode(n[o](h,i))}else if(typeof n[o]!=='object'){x_val=B.URLSafeBase64Encode(n[o])}x_vars_url+='/x:'+o+'/'+x_val}}}var p='http://up.qiniu.com/mkfile/'+i.size+m+x_vars_url;var q=B.createAjax();q.open('POST',p,true);q.setRequestHeader('Content-Type','text/plain;charset=UTF-8');q.setRequestHeader('Authorization','UpToken '+B.token);q.onreadystatechange=function(){if(q.readyState===4){localStorage.removeItem(i.name);if(q.status===200){var a=q.responseText;k(h,i,a)}else{A.trigger('Error',{status:q.status,response:q.responseText,file:i,code:-200})}}};q.send(w)}else{k(h,i,j.response)}}})(v));return A};this.getUrl=function(a){if(!a){return false}a=encodeURI(a);var b=this.domain;if(b.slice(b.length-1)!=='/'){b=b+'/'}return b+a};this.imageView2=function(a,b){var c=a.mode||'',w=a.w||'',h=a.h||'',q=a.quality||'',format=a.format||'';if(!c){return false}if(!w&&!h){return false}var d='imageView2/'+c;d+=w?'/w/'+w:'';d+=h?'/h/'+h:'';d+=q?'/q/'+q:'';d+=format?'/format/'+format:'';if(b){d=this.getUrl(b)+'?'+d}return d};this.imageMogr2=function(a,b){var c=a['auto-orient']||'',thumbnail=a.thumbnail||'',strip=a.strip||'',gravity=a.gravity||'',crop=a.crop||'',quality=a.quality||'',rotate=a.rotate||'',format=a.format||'',blur=a.blur||'';var d='imageMogr2';d+=c?'/auto-orient':'';d+=thumbnail?'/thumbnail/'+thumbnail:'';d+=strip?'/strip':'';d+=gravity?'/gravity/'+gravity:'';d+=quality?'/quality/'+quality:'';d+=crop?'/crop/'+crop:'';d+=rotate?'/rotate/'+rotate:'';d+=format?'/format/'+format:'';d+=blur?'/blur/'+blur:'';if(b){d=this.getUrl(b)+'?'+d}return d};this.watermark=function(a,b){var c=a.mode;if(!c){return false}var d='watermark/'+c;if(c===1){var e=a.image||'';if(!e){return false}d+=e?'/image/'+this.URLSafeBase64Encode(e):''}else if(c===2){var f=a.text?a.text:'',font=a.font?a.font:'',fontsize=a.fontsize?a.fontsize:'',fill=a.fill?a.fill:'';if(!f){return false}d+=f?'/text/'+this.URLSafeBase64Encode(f):'';d+=font?'/font/'+this.URLSafeBase64Encode(font):'';d+=fontsize?'/fontsize/'+fontsize:'';d+=fill?'/fill/'+this.URLSafeBase64Encode(fill):''}else{return false}var g=a.dissolve||'',gravity=a.gravity||'',dx=a.dx||'',dy=a.dy||'';d+=g?'/dissolve/'+g:'';d+=gravity?'/gravity/'+gravity:'';d+=dx?'/dx/'+dx:'';d+=dy?'/dy/'+dy:'';if(b){d=this.getUrl(b)+'?'+d}return d};this.imageInfo=function(a){if(!a){return false}var b=this.getUrl(a)+'?imageInfo';var c=this.createAjax();var d;var e=this;c.open('GET',b,false);c.onreadystatechange=function(){if(c.readyState===4&&c.status===200){d=e.parseJSON(c.responseText)}};c.send();return d};this.exif=function(a){if(!a){return false}var b=this.getUrl(a)+'?exif';var c=this.createAjax();var d;var e=this;c.open('GET',b,false);c.onreadystatechange=function(){if(c.readyState===4&&c.status===200){d=e.parseJSON(c.responseText)}};c.send();return d};this.get=function(a,b){if(!b||!a){return false}if(a==='exif'){return this.exif(b)}else if(a==='imageInfo'){return this.imageInfo(b)}return false};this.pipeline=function(a,b){var c=Object.prototype.toString.call(a)==='[object Array]';var d,errOp,imageUrl='';if(c){for(var i=0,len=a.length;i<len;i++){d=a[i];if(!d.fop){return false}switch(d.fop){case'watermark':imageUrl+=this.watermark(d)+'|';break;case'imageView2':imageUrl+=this.imageView2(d)+'|';break;case'imageMogr2':imageUrl+=this.imageMogr2(d)+'|';break;default:errOp=true;break}if(errOp){return false}}if(b){imageUrl=this.getUrl(b)+'?'+imageUrl;var e=imageUrl.length;if(imageUrl.slice(e-1)==='|'){imageUrl=imageUrl.slice(0,e-1)}}return imageUrl}return false}}var Qiniu=new QiniuJsSDK();